import { type IAgentRuntime, Service, elizaLogger } from '@elizaos/core';

/**
 * Interface for OpenAI image generation API response
 */
interface OpenAIImageResponse {
  created: number;
  data: Array<{
    url?: string;
    revised_prompt?: string;
  }>;
}

/**
 * Service for generating images using OpenAI's gpt-image-1 model
 * See: https://platform.openai.com/docs/guides/images
 */
export class ImageGenerationService extends Service {
  static serviceType = 'image_generation';
  capabilityDescription = 'Generates images using OpenAI gpt-image-1';

  constructor(runtime: IAgentRuntime) {
    super(runtime);
    this.runtime = runtime;
  }

  async stop(): Promise<void> {
    // Nothing to stop
  }

  /**
   * Generates an image based on a text prompt using OpenAI's gpt-image-1 model
   * @param prompt The text description to generate an image from
   * @returns Generated image URL
   * @throws Error if the generation fails
   */
  async generateImage(prompt: string): Promise<string> {
    try {
      // Get the OpenAI API key
      const apiKey = this.runtime.getSetting('OPENAI_API_KEY');
      if (!apiKey) {
        throw new Error('OPENAI_API_KEY is not set');
      }

      elizaLogger.log('Generating image with prompt:', prompt);

      // Call OpenAI API to generate image
      // Using gpt-image-1 model - OpenAI's latest model for image generation
      const response = await fetch('https://api.openai.com/v1/images/generations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: 'gpt-image-1', // Specific model as required
          prompt,
          n: 1,
          size: '1024x1024', // Default size for gpt-image-1
          response_format: 'url',
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        elizaLogger.error('OpenAI API error:', errorData);
        throw new Error(`OpenAI API error: ${response.statusText}`);
      }

      const data = (await response.json()) as OpenAIImageResponse;

      if (!data.data || data.data.length === 0 || !data.data[0].url) {
        throw new Error('No image was generated by OpenAI');
      }

      elizaLogger.log('Image URL received from OpenAI');

      // Return the image URL
      return data.data[0].url;
    } catch (error) {
      elizaLogger.error('Failed to generate image with OpenAI:', error);
      throw error;
    }
  }
}

export default ImageGenerationService;
